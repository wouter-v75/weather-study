<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Historical Weather Data Map</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }
    #root {
      width: 100%;
      height: 100vh;
    }
    .chart-container {
      position: relative;
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="root">
    <div class="w-full h-screen flex flex-col bg-gray-50">
      <div class="bg-white shadow-sm border-b p-4">
        <h1 class="text-2xl font-bold text-gray-800">Historical Weather Data Map</h1>
        <p class="text-sm text-gray-600 mt-1">Select points and analyze wind speed patterns by month across years</p>
      </div>

      <div class="flex flex-1 overflow-hidden">
        <div class="w-1/3 border-r bg-white overflow-y-auto">
          <div class="p-4 space-y-4">
            <div>
              <h2 class="font-semibold text-lg mb-2">Selected Points (<span id="pointCount">0</span>/3)</h2>
              <div id="pointsList" class="space-y-2">
                <p class="text-sm text-gray-500">Click on the map to add points</p>
              </div>
            </div>

            <div class="border-t pt-4">
              <h2 class="font-semibold text-lg mb-3">Time Period</h2>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium mb-1">Year Range</label>
                  <div class="flex gap-2 items-center">
                    <input
                      type="number"
                      id="startYear"
                      value="2020"
                      min="1940"
                      max="2024"
                      class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                    <span class="text-gray-500">to</span>
                    <input
                      type="number"
                      id="endYear"
                      value="2024"
                      min="1940"
                      max="2024"
                      class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                    />
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Month</label>
                  <select
                    id="selectedMonth"
                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                  >
                    <option value="01">January</option>
                    <option value="02">February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="border-t pt-4">
              <h2 class="font-semibold text-lg mb-3">Daily Time Window</h2>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium mb-1">Start Time</label>
                  <input
                    type="time"
                    id="startTime"
                    value="10:00"
                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">End Time</label>
                  <input
                    type="time"
                    id="endTime"
                    value="18:00"
                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                  />
                </div>
                <p class="text-xs text-gray-600">
                  Data will be averaged between <span id="displayStartTime">10:00</span> and <span id="displayEndTime">18:00</span> each day
                </p>
              </div>
            </div>

            <button
              id="fetchBtn"
              onclick="fetchWeatherData()"
              class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed font-medium"
            >
              Fetch Weather Data
            </button>
          </div>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden">
          <div id="map" class="flex-1" style="min-height: 300px;"></div>
          
          <div id="chartsContainer" class="flex-1 bg-white border-t overflow-y-auto" style="display: none;">
            <div class="p-4 space-y-6">
              <div>
                <h2 class="font-semibold text-lg mb-2" id="avgChartTitle">Average Wind Speed at 10m (knots) by Day of Month</h2>
                <div style="height: 300px;">
                  <canvas id="avgChart"></canvas>
                </div>
              </div>
              
              <div class="border-t pt-4">
                <h2 class="font-semibold text-lg mb-2">Wind Speed Distribution at 10m (knots)</h2>
                <div style="height: 300px;">
                  <canvas id="distChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let map = null;
    let points = [];
    let markers = [];
    let weatherData = [];
    let avgChart = null;
    let distChart = null;
    const colors = ['#3b82f6', '#ef4444', '#10b981'];

    // Initialize map
    function initMap() {
      map = L.map('map').setView([40, -95], 4);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      map.on('click', function(e) {
        if (points.length < 3) {
          const newPoint = {
            lat: e.latlng.lat,
            lng: e.latlng.lng,
            id: Date.now(),
            name: `Point ${points.length + 1}`
          };
          
          const marker = L.marker([e.latlng.lat, e.latlng.lng])
            .addTo(map)
            .bindPopup(`Point ${points.length + 1}<br>Lat: ${e.latlng.lat.toFixed(4)}<br>Lng: ${e.latlng.lng.toFixed(4)}`)
            .openPopup();
          
          markers.push(marker);
          points.push(newPoint);
          updatePointsList();
        }
      });
    }

    function updatePointsList() {
      const pointsList = document.getElementById('pointsList');
      const pointCount = document.getElementById('pointCount');
      pointCount.textContent = points.length;

      if (points.length === 0) {
        pointsList.innerHTML = '<p class="text-sm text-gray-500">Click on the map to add points</p>';
      } else {
        pointsList.innerHTML = points.map((point, idx) => `
          <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
            <div class="flex-1">
              <div class="font-medium" style="color: ${colors[idx]}">${point.name}</div>
              <div class="text-xs text-gray-600">${point.lat.toFixed(4)}, ${point.lng.toFixed(4)}</div>
            </div>
            <button onclick="removePoint(${point.id})" class="text-red-500 hover:text-red-700 text-sm px-2 py-1">
              Remove
            </button>
          </div>
        `).join('');
      }
    }

    function removePoint(id) {
      const index = points.findIndex(p => p.id === id);
      if (index !== -1) {
        map.removeLayer(markers[index]);
        markers.splice(index, 1);
        points.splice(index, 1);
        weatherData = weatherData.filter(d => d.pointId !== id);
        updatePointsList();
        if (weatherData.length > 0) {
          updateCharts();
        } else {
          document.getElementById('chartsContainer').style.display = 'none';
        }
      }
    }

    function isTimeInRange(timeStr, startTime, endTime) {
      const hour = parseInt(timeStr.split('T')[1].split(':')[0]);
      const startHour = parseInt(startTime.split(':')[0]);
      const endHour = parseInt(endTime.split(':')[0]);
      return hour >= startHour && hour <= endHour;
    }

    function getDaysInMonth(month) {
      const days = {
        '01': 31, '02': 29, '03': 31, '04': 30, '05': 31, '06': 30,
        '07': 31, '08': 31, '09': 30, '10': 31, '11': 30, '12': 31
      };
      return days[month];
    }

    async function fetchWeatherData() {
      if (points.length === 0) {
        alert('Please select at least one point on the map');
        return;
      }

      const btn = document.getElementById('fetchBtn');
      btn.disabled = true;
      btn.textContent = 'Loading...';

      const startYear = parseInt(document.getElementById('startYear').value);
      const endYear = parseInt(document.getElementById('endYear').value);
      const selectedMonth = document.getElementById('selectedMonth').value;
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;

      document.getElementById('displayStartTime').textContent = startTime;
      document.getElementById('displayEndTime').textContent = endTime;

      weatherData = [];

      try {
        for (const point of points) {
          for (let year = startYear; year <= endYear; year++) {
            const daysInMonth = getDaysInMonth(selectedMonth);
            const startDate = `${year}-${selectedMonth}-01`;
            const endDate = `${year}-${selectedMonth}-${daysInMonth}`;

            const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${point.lat}&longitude=${point.lng}&start_date=${startDate}&end_date=${endDate}&hourly=windspeed_10m&timezone=auto`;
            
            const response = await fetch(url);
            const data = await response.json();

            if (data.hourly) {
              const filteredData = data.hourly.time
                .map((time, idx) => ({
                  time,
                  wind: data.hourly.windspeed_10m[idx]
                }))
                .filter(item => isTimeInRange(item.time, startTime, endTime));

              filteredData.forEach(item => {
                const date = item.time.split('T')[0];
                const dayOfMonth = parseInt(date.split('-')[2]);
                
                // Convert km/h to knots (1 km/h = 0.539957 knots)
                const windSpeedKnots = item.wind * 0.539957;
                
                weatherData.push({
                  pointId: point.id,
                  pointName: point.name,
                  year: year,
                  dayOfMonth: dayOfMonth,
                  windSpeed: windSpeedKnots
                });
              });
            }
          }
        }

        document.getElementById('chartsContainer').style.display = 'block';
        updateCharts();
      } catch (error) {
        alert('Error fetching weather data: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Fetch Weather Data';
      }
    }

    function updateCharts() {
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;
      const startYear = document.getElementById('startYear').value;
      const endYear = document.getElementById('endYear').value;
      const monthName = document.getElementById('selectedMonth').selectedOptions[0].text;

      // Calculate average wind speed by day of month for each point
      const avgByDay = {};
      
      points.forEach(point => {
        avgByDay[point.name] = {};
        for (let day = 1; day <= 31; day++) {
          const dayData = weatherData.filter(d => 
            d.pointId === point.id && d.dayOfMonth === day
          );
          if (dayData.length > 0) {
            const avg = dayData.reduce((sum, d) => sum + d.windSpeed, 0) / dayData.length;
            avgByDay[point.name][day] = avg;
          }
        }
      });

      // Update average chart
      const days = Array.from({length: 31}, (_, i) => i + 1);
      const avgDatasets = points.map((point, idx) => ({
        label: point.name,
        data: days.map(day => avgByDay[point.name][day] || null),
        borderColor: colors[idx],
        backgroundColor: colors[idx],
        tension: 0.1,
        spanGaps: true
      }));

      document.getElementById('avgChartTitle').textContent = 
        `Average Wind Speed at 10m (knots) by Day of Month (${monthName} ${startYear}-${endYear}, ${startTime}-${endTime})`;

      if (avgChart) avgChart.destroy();
      const avgCtx = document.getElementById('avgChart').getContext('2d');
      avgChart = new Chart(avgCtx, {
        type: 'line',
        data: {
          labels: days,
          datasets: avgDatasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              mode: 'index',
              intersect: false,
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Day of Month' }
            },
            y: {
              title: { display: true, text: 'Wind Speed (knots)' },
              beginAtZero: true
            }
          }
        }
      });

      // Calculate wind speed distribution (in knots)
      const bins = [0, 3, 6, 9, 12, 15, 18, 21, 24, 100];
      const binLabels = bins.slice(0, -1).map((b, i) => `${b}-${bins[i+1]} kts`);
      
      const distDatasets = points.map((point, idx) => {
        const pointData = weatherData.filter(d => d.pointId === point.id);
        const total = pointData.length;
        const counts = new Array(bins.length - 1).fill(0);
        
        pointData.forEach(d => {
          for (let i = 0; i < bins.length - 1; i++) {
            if (d.windSpeed >= bins[i] && d.windSpeed < bins[i + 1]) {
              counts[i]++;
              break;
            }
          }
        });
        
        const percentages = counts.map(c => (c / total * 100).toFixed(1));
        
        return {
          label: point.name,
          data: percentages,
          backgroundColor: colors[idx],
          borderColor: colors[idx],
          borderWidth: 1
        };
      });

      if (distChart) distChart.destroy();
      const distCtx = document.getElementById('distChart').getContext('2d');
      distChart = new Chart(distCtx, {
        type: 'bar',
        data: {
          labels: binLabels,
          datasets: distDatasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y + '%';
                }
              }
            }
          },
          scales: {
            x: {
              title: { display: true, text: 'Wind Speed Range' }
            },
            y: {
              title: { display: true, text: 'Percentage (%)' },
              beginAtZero: true
            }
          }
        }
      });
    }

    // Initialize when page loads
    window.addEventListener('load', function() {
      initMap();
    });
  </script>
</body>
</html>
