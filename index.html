<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Historical Weather Data Map</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    }
    #root {
      width: 100%;
      height: 100vh;
    }
    .chart-container {
      position: relative;
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="root">
    <div class="w-full h-screen flex flex-col bg-gray-50">
      <div class="bg-white shadow-sm border-b p-4">
        <h1 class="text-2xl font-bold text-gray-800">Historical Weather Data Map</h1>
        <p class="text-sm text-gray-600 mt-1">Click on the map to select up to 3 points, then fetch weather data for specific time windows</p>
      </div>

      <div class="flex flex-1 overflow-hidden">
        <div class="w-1/3 border-r bg-white overflow-y-auto">
          <div class="p-4 space-y-4">
            <div>
              <h2 class="font-semibold text-lg mb-2">Selected Points (<span id="pointCount">0</span>/3)</h2>
              <div id="pointsList" class="space-y-2">
                <p class="text-sm text-gray-500">Click on the map to add points</p>
              </div>
            </div>

            <div class="border-t pt-4">
              <h2 class="font-semibold text-lg mb-3">Date Range</h2>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium mb-1">Start Date</label>
                  <input
                    type="date"
                    id="startDate"
                    value="2024-01-01"
                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">End Date</label>
                  <input
                    type="date"
                    id="endDate"
                    value="2024-01-31"
                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                  />
                </div>
              </div>
            </div>

            <div class="border-t pt-4">
              <h2 class="font-semibold text-lg mb-3">Daily Time Window</h2>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium mb-1">Start Time</label>
                  <input
                    type="time"
                    id="startTime"
                    value="10:00"
                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">End Time</label>
                  <input
                    type="time"
                    id="endTime"
                    value="18:00"
                    class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
                  />
                </div>
                <p class="text-xs text-gray-600">
                  Data will be averaged between <span id="displayStartTime">10:00</span> and <span id="displayEndTime">18:00</span> each day
                </p>
              </div>
            </div>

            <button
              id="fetchBtn"
              onclick="fetchWeatherData()"
              class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed font-medium"
            >
              Fetch Weather Data
            </button>

            <div id="metricSelector" class="border-t pt-4" style="display: none;">
              <h2 class="font-semibold text-lg mb-3">Display Metric</h2>
              <select
                id="selectedMetric"
                onchange="updateChart()"
                class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none"
              >
                <option value="temperature">Temperature</option>
                <option value="precipitation">Precipitation</option>
                <option value="windSpeed">Wind Speed</option>
                <option value="humidity">Humidity</option>
              </select>
            </div>
          </div>
        </div>

        <div class="flex-1 flex flex-col">
          <div id="map" class="flex-1" style="min-height: 400px;"></div>
          
          <div id="chartContainer" class="h-80 bg-white border-t p-4" style="display: none;">
            <h2 class="font-semibold text-lg mb-2" id="chartTitle">Temperature (°C)</h2>
            <div class="chart-container">
              <canvas id="weatherChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global state
    let map = null;
    let points = [];
    let markers = [];
    let weatherData = [];
    let chart = null;
    const colors = ['#3b82f6', '#ef4444', '#10b981'];

    // Initialize map
    function initMap() {
      map = L.map('map').setView([40, -95], 4);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      map.on('click', function(e) {
        if (points.length < 3) {
          const newPoint = {
            lat: e.latlng.lat,
            lng: e.latlng.lng,
            id: Date.now(),
            name: `Point ${points.length + 1}`
          };
          
          const marker = L.marker([e.latlng.lat, e.latlng.lng])
            .addTo(map)
            .bindPopup(`Point ${points.length + 1}<br>Lat: ${e.latlng.lat.toFixed(4)}<br>Lng: ${e.latlng.lng.toFixed(4)}`)
            .openPopup();
          
          markers.push(marker);
          points.push(newPoint);
          updatePointsList();
        }
      });
    }

    function updatePointsList() {
      const pointsList = document.getElementById('pointsList');
      const pointCount = document.getElementById('pointCount');
      pointCount.textContent = points.length;

      if (points.length === 0) {
        pointsList.innerHTML = '<p class="text-sm text-gray-500">Click on the map to add points</p>';
      } else {
        pointsList.innerHTML = points.map((point, idx) => `
          <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
            <div class="flex-1">
              <div class="font-medium" style="color: ${colors[idx]}">${point.name}</div>
              <div class="text-xs text-gray-600">${point.lat.toFixed(4)}, ${point.lng.toFixed(4)}</div>
            </div>
            <button onclick="removePoint(${point.id})" class="text-red-500 hover:text-red-700 text-sm px-2 py-1">
              Remove
            </button>
          </div>
        `).join('');
      }
    }

    function removePoint(id) {
      const index = points.findIndex(p => p.id === id);
      if (index !== -1) {
        map.removeLayer(markers[index]);
        markers.splice(index, 1);
        points.splice(index, 1);
        weatherData = weatherData.filter(d => d.pointId !== id);
        updatePointsList();
        if (weatherData.length > 0) {
          updateChart();
        } else {
          document.getElementById('chartContainer').style.display = 'none';
          document.getElementById('metricSelector').style.display = 'none';
        }
      }
    }

    function isTimeInRange(timeStr, startTime, endTime) {
      const hour = parseInt(timeStr.split('T')[1].split(':')[0]);
      const startHour = parseInt(startTime.split(':')[0]);
      const endHour = parseInt(endTime.split(':')[0]);
      return hour >= startHour && hour <= endHour;
    }

    async function fetchWeatherData() {
      if (points.length === 0) {
        alert('Please select at least one point on the map');
        return;
      }

      const btn = document.getElementById('fetchBtn');
      btn.disabled = true;
      btn.textContent = 'Loading...';

      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;

      document.getElementById('displayStartTime').textContent = startTime;
      document.getElementById('displayEndTime').textContent = endTime;

      weatherData = [];

      try {
        for (const point of points) {
          const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${point.lat}&longitude=${point.lng}&start_date=${startDate}&end_date=${endDate}&hourly=temperature_2m,precipitation,windspeed_10m,relativehumidity_2m&timezone=auto`;
          
          const response = await fetch(url);
          const data = await response.json();

          if (data.hourly) {
            const filteredData = data.hourly.time
              .map((time, idx) => ({
                time,
                temp: data.hourly.temperature_2m[idx],
                precip: data.hourly.precipitation[idx],
                wind: data.hourly.windspeed_10m[idx],
                humidity: data.hourly.relativehumidity_2m[idx]
              }))
              .filter(item => isTimeInRange(item.time, startTime, endTime));

            const dailyData = {};
            filteredData.forEach(item => {
              const date = item.time.split('T')[0];
              if (!dailyData[date]) {
                dailyData[date] = {
                  temps: [],
                  precips: [],
                  winds: [],
                  humidities: []
                };
              }
              dailyData[date].temps.push(item.temp);
              dailyData[date].precips.push(item.precip);
              dailyData[date].winds.push(item.wind);
              dailyData[date].humidities.push(item.humidity);
            });

            Object.keys(dailyData).forEach(date => {
              const day = dailyData[date];
              weatherData.push({
                date,
                pointId: point.id,
                pointName: point.name,
                tempMean: day.temps.reduce((a, b) => a + b, 0) / day.temps.length,
                precipitation: day.precips.reduce((a, b) => a + b, 0),
                windSpeed: day.winds.reduce((a, b) => a + b, 0) / day.winds.length,
                humidity: day.humidities.reduce((a, b) => a + b, 0) / day.humidities.length
              });
            });
          }
        }

        document.getElementById('metricSelector').style.display = 'block';
        document.getElementById('chartContainer').style.display = 'block';
        updateChart();
      } catch (error) {
        alert('Error fetching weather data: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Fetch Weather Data';
      }
    }

    function updateChart() {
      const selectedMetric = document.getElementById('selectedMetric').value;
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;

      const groupedByDate = {};
      weatherData.forEach(item => {
        if (!groupedByDate[item.date]) {
          groupedByDate[item.date] = { date: item.date };
        }
        
        const value = selectedMetric === 'temperature' ? item.tempMean :
                     selectedMetric === 'precipitation' ? item.precipitation :
                     selectedMetric === 'humidity' ? item.humidity :
                     item.windSpeed;
        
        groupedByDate[item.date][item.pointName] = value;
      });

      const chartData = Object.values(groupedByDate);
      const dates = chartData.map(d => d.date);

      const datasets = points.map((point, idx) => ({
        label: point.name,
        data: chartData.map(d => d[point.name]),
        borderColor: colors[idx],
        backgroundColor: colors[idx],
        tension: 0.1
      }));

      const metricLabels = {
        temperature: 'Temperature (°C)',
        precipitation: 'Precipitation (mm)',
        windSpeed: 'Wind Speed (km/h)',
        humidity: 'Humidity (%)'
      };

      document.getElementById('chartTitle').textContent = `${metricLabels[selectedMetric]} (${startTime} - ${endTime})`;

      if (chart) {
        chart.destroy();
      }

      const ctx = document.getElementById('weatherChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              mode: 'index',
              intersect: false,
            }
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'Date'
              }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: metricLabels[selectedMetric]
              }
            }
          }
        }
      });
    }

    // Initialize when page loads
    window.addEventListener('load', function() {
      initMap();
    });
  </script>
</body>
</html>
